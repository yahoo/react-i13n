/* global describe, it, document, before, browser, expect */
'use strict';

describe('React I13n test', function () {
    it('should init correctly and give the rootI13nNode the correct default model value', function () {
        var result = window._reactI13nInstance.getRootI13nNode().getMergedModel();
        expect(result).to.eql({sec: 'default-section-name', page: 'test-page'});
    });
    
    it('should fire a pageview', function () {
        var events = window.firedEvents;
        expect(events[0].name).to.eql('pageview');
    });
    
    it('should fire an update event when dom change, should get i13n model updated', function () {
        var hiddenBtn = document.querySelectorAll('.HiddenBtn')[0];
        hiddenBtn.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 2].name).to.eql('click');
        expect(events[currentEventCount - 2].model).to.eql({sec: 'hidden-btn', page: 'test-page', expend: false});
        expect(events[currentEventCount - 1].name).to.eql('created');
        
        // click the link and expect the expend value is updated
        var hiddenLink = document.querySelectorAll('.I13nComponentLevel2Hidden a')[0];
        hiddenLink.click();
        currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({sec: 'hidden-btn', page: 'test-page', expend: true});
    });
    
    it('should handle nested model data well', function () {
        var nestTestI13nComponentLevel3 = document.querySelectorAll('.NestTestI13nComponentLevel3')[0];
        nestTestI13nComponentLevel3.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].model).to.eql({
            page: 'test-page',
            sec: 'level1',
            vl1: 'foo',
            vl2: 'bar',
            vl3: 'baz',
            vl3_ovr: 'baz'
        });
    });
    
    it('should fire a click beacon', function () {
        var link = document.querySelectorAll('.NormalLink a')[0];
        link.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({page: 'test-page', sec: 'foo'});
        expect(events[currentEventCount - 1].text).to.eql('NormalLink');
        expect(events[currentEventCount - 1].position).to.eql(1);
    });

    it('should fire a click beacon by model generated by function', function () {
        var link = document.querySelectorAll('.NormalLinkWithFunctionModel a')[0];
        link.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({page: 'test-page', sec: 'dynamical-generated'});
        expect(events[currentEventCount - 1].text).to.eql('NormalLinkWithFunctionModel');
        expect(events[currentEventCount - 1].position).to.eql(2);
    });

    it('should fire a click beacon without redirect page if link is hash url', function () {
        var link = document.querySelectorAll('.LinkWithHashUrl a')[0];
        link.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({page: 'test-page', sec:'foo'});
        expect(events[currentEventCount - 1].text).to.eql('LinkWithHashUrl');
        expect(events[currentEventCount - 1].position).to.eql(3);
    });
    
    it('should fire a click beacon without do anything if target="_blank"', function () {
        var link = document.querySelectorAll('.NormalLinkWithTargetBlank a')[0];
        link.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({page: 'test-page', sec:'foo'});
        expect(events[currentEventCount - 1].text).to.eql('NormalLinkWithTargetBlank');
        expect(events[currentEventCount - 1].position).to.eql(4);
    });
    
    it('should fire a click for the auto-scanned links', function () {
        var link = document.querySelectorAll('.AutoScanLink')[0];
        link.click();
        var events = window.firedEvents;
        var currentEventCount = events.length;
        expect(events[currentEventCount - 1].name).to.eql('click');
        expect(events[currentEventCount - 1].model).to.eql({page: 'test-page', sec:'auto-scan'});
        expect(events[currentEventCount - 1].text).to.eql('AutoScanLink');
        expect(events[currentEventCount - 1].position).to.eql(1);
    });
});
